name: Update Card List

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-cards:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true) || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper date checking
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Check if script needs to run
      id: check_run
      run: |
        # Check if formatted_card_list.js exists and get its last modified time
        if [ -f "formatted_card_list.js" ]; then
          # Get the last commit date that modified formatted_card_list.js
          LAST_MODIFIED=$(git log -1 --format="%ct" -- formatted_card_list.js 2>/dev/null || echo "0")
          CURRENT_TIME=$(date +%s)
          TIME_DIFF=$((CURRENT_TIME - LAST_MODIFIED))
          HOURS_DIFF=$((TIME_DIFF / 3600))
          
          echo "Last modified: $LAST_MODIFIED"
          echo "Current time: $CURRENT_TIME"
          echo "Hours since last update: $HOURS_DIFF"
          
          if [ $HOURS_DIFF -lt 48 ]; then
            echo "Script was run less than 48 hours ago. Skipping execution."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "Script hasn't been run in 48+ hours. Running update."
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "formatted_card_list.js not found. Running script to create it."
          echo "should_run=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Run card list update script
      if: steps.check_run.outputs.should_run == 'true'
      run: |
        echo "ðŸš€ Running pullCards.py to update card list..."
        python pullCards.py
    
    - name: Check for changes
      if: steps.check_run.outputs.should_run == 'true'
      id: check_changes
      run: |
        if git diff --quiet formatted_card_list.js; then
          echo "No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected in formatted_card_list.js"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check_run.outputs.should_run == 'true' && steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add formatted_card_list.js
        git commit -m "ðŸŽ¯ Auto-update card list with latest cards from Scryfall
        
        - Updated card list using pullCards.py
        - Added new cards from latest Scryfall oracle data
        - Automated update via GitHub Actions"
        git push
    
    - name: Summary
      if: always()
      run: |
        if [ "${{ steps.check_run.outputs.should_run }}" == "false" ]; then
          echo "âœ… Card list is up to date (updated within last 48 hours)"
        elif [ "${{ steps.check_changes.outputs.has_changes }}" == "false" ]; then
          echo "âœ… Script ran successfully, but no new cards were found"
        elif [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
          echo "ðŸŽ¯ Card list updated successfully with new cards!"
        else
          echo "ðŸ“‹ Script execution completed"
        fi