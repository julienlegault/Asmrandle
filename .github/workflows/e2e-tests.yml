name: Build and Deploy

on:
  workflow_dispatch:  # Allow manual triggering
  workflow_call:      # Allow this workflow to be called by other workflows

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Update card list job (only for scheduled runs)
  update-cards:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper date checking
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Check if script needs to run
      id: check_run
      run: |
        # Check if formatted_card_list.js exists and get its last modified time
        if [ -f "formatted_card_list.js" ]; then
          # Get the last commit date that modified formatted_card_list.js
          LAST_MODIFIED=$(git log -1 --format="%ct" -- formatted_card_list.js 2>/dev/null || echo "0")
          CURRENT_TIME=$(date +%s)
          TIME_DIFF=$((CURRENT_TIME - LAST_MODIFIED))
          DAYS_DIFF=$((TIME_DIFF / 86400))
          
          echo "Last modified: $LAST_MODIFIED ($(date -d @$LAST_MODIFIED))"
          echo "Current time: $CURRENT_TIME ($(date -d @$CURRENT_TIME))"
          echo "Days since last update: $DAYS_DIFF"
          
          # For scheduled runs, use 25-day threshold
          if [ $DAYS_DIFF -lt 25 ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "File was updated $DAYS_DIFF days ago (less than 25 days)"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "File was updated $DAYS_DIFF days ago (more than 25 days) - will update"
          fi
        else
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "formatted_card_list.js doesn't exist - will create"
        fi
    
    - name: Run card update script
      if: steps.check_run.outputs.should_run == 'true'
      run: |
        echo "Running pullCards.py to update card list..."
        python pullCards.py
    
    - name: Check for changes
      if: steps.check_run.outputs.should_run == 'true'
      id: check_changes
      run: |
        if git diff --quiet formatted_card_list.js 2>/dev/null; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in formatted_card_list.js"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in formatted_card_list.js"
        fi
    
    - name: Commit and push changes
      if: steps.check_run.outputs.should_run == 'true' && steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add formatted_card_list.js
        git commit -m "ðŸ—“ï¸ Monthly auto-update card list with latest cards from Scryfall
        
        - Scheduled monthly update using pullCards.py
        - Added new cards from latest Scryfall oracle data
        - Automated monthly maintenance via GitHub Actions"
        git push

  # Build and test job
  test:
    runs-on: ubuntu-latest
    needs: [update-cards]
    if: always() && (needs.update-cards.result == 'success' || needs.update-cards.result == 'skipped')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # If update-cards ran and made changes, we need to fetch the latest
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm init -y
          npm install --save-dev @playwright/test
          npx playwright install --with-deps chromium

      - name: Start local server for testing
        run: |
          # Start a simple HTTP server in the background
          python3 -m http.server 3000 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          # Wait for server to start
          sleep 5
          # Verify server is running
          curl -f http://localhost:3000 || exit 1

      - name: Create E2E test file
        run: |
          mkdir -p tests
          cat > tests/e2e.spec.js << 'EOF'
          const { test, expect } = require('@playwright/test');

          test.describe('Asmrandle E2E Tests', () => {
            
            test('Homepage loads correctly', async ({ page }) => {
              await page.goto('http://localhost:3000');
              
              // Check page title
              await expect(page).toHaveTitle(/Asmrandle/);
              
              // Check that main menu buttons are present
              await expect(page.locator('#start-daily')).toBeVisible();
              await expect(page.locator('#play-random')).toBeVisible();
              
              // Check footer elements
              await expect(page.locator('.footer')).toBeVisible();
              await expect(page.locator('.footer a img')).toBeVisible(); // LinkedIn icon
            });

            test('Daily game button functionality', async ({ page }) => {
              await page.goto('http://localhost:3000');
              
              // Click daily game button
              await page.click('#start-daily');
              
              // Wait for game to load
              await page.waitForSelector('#game', { timeout: 10000 });
              
              // Check that game area is visible and main menu is hidden
              await expect(page.locator('#main-menu')).toBeHidden();
              await expect(page.locator('#game')).toBeVisible();
              
              // Check that scoreboard dots are present
              await expect(page.locator('.scoreboard .dot')).toHaveCount(10);
            });

            test('Practice game button functionality', async ({ page }) => {
              await page.goto('http://localhost:3000');
              
              // Click practice button
              await page.click('#play-random');
              
              // Wait for game to load
              await page.waitForSelector('#game', { timeout: 10000 });
              
              // Check that game area is visible and main menu is hidden
              await expect(page.locator('#main-menu')).toBeHidden();
              await expect(page.locator('#game')).toBeVisible();
              
              // Check that scoreboard dots are present
              await expect(page.locator('.scoreboard .dot')).toHaveCount(10);
            });

            test('Game cards load and are clickable', async ({ page }) => {
              await page.goto('http://localhost:3000');
              
              // Start a practice game
              await page.click('#play-random');
              
              // Wait for cards to load
              await page.waitForSelector('.card img', { timeout: 15000 });
              
              // Check that exactly 2 cards are present
              await expect(page.locator('.card')).toHaveCount(2);
              
              // Check that cards have images
              const cardImages = page.locator('.card img');
              await expect(cardImages).toHaveCount(2);
              
              // Verify images have src attributes (cards loaded)
              const firstCard = cardImages.first();
              const firstCardSrc = await firstCard.getAttribute('src');
              expect(firstCardSrc).toBeTruthy();
              expect(firstCardSrc).toContain('http'); // Should be a valid URL
            });

            test('Card click functionality and game progression', async ({ page }) => {
              await page.goto('http://localhost:3000');
              
              // Start a practice game
              await page.click('#play-random');
              
              // Wait for cards to load
              await page.waitForSelector('.card img', { timeout: 15000 });
              
              // Click on the first card
              await page.click('.card:first-child');
              
              // Wait for overlay to appear and disappear
              await page.waitForSelector('.overlay', { timeout: 5000 });
              await page.waitForSelector('.overlay', { state: 'detached', timeout: 5000 });
              
              // Check that first dot in scoreboard has changed color (red or green)
              const firstDot = page.locator('.scoreboard .dot:first-child');
              const backgroundColor = await firstDot.evaluate(el => getComputedStyle(el).backgroundColor);
              expect(backgroundColor).not.toBe('rgb(128, 128, 128)'); // Should not be gray anymore
            });

            test('Cookie retrieved correctly and used', async ({ page }) => {
              await page.goto('http://localhost:3000');

              // Set daily cookie to a known value
              page.context().addCookies([{
                name: '20251101',
                value: 'true,true,true,true,true,false,false,false,false,false',
                domain: 'localhost',
              }]);

              // Start daily game
              await page.click('#start-daily');
              await page.waitForSelector('#results', { timeout: 10000 });

              // Check that results reflect cookie values
              const resultsText = await page.locator('#results').innerText();
              expect(resultsText).toContain('ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ¥ðŸŸ¥ðŸŸ¥ðŸŸ¥ðŸŸ¥ 5/10');
            });

            test('Play full game', async ({ page }) => {
              await page.goto('http://localhost:3000');
              
              // Start a practice game
              await page.click('#play-random');
              
              // Wait for game to load
              await page.waitForSelector('#game', { timeout: 10000 });
              
              // Play through all 10 cards
              for (let i = 0; i < 10; i++) {
                // Wait for cards to load
                await page.waitForSelector('.card img', { timeout: 15000 });
                
                // Click on the first card
                await page.click('.card:first-child');
                
                // Wait for overlay to appear and disappear
                await page.waitForSelector('.overlay', { timeout: 5000 });
                await page.waitForSelector('.overlay', { state: 'detached', timeout: 5000 });
              }
              
              // After 10 cards, check that results are shown
              await page.waitForSelector('#results', { timeout: 10000 });
              const resultsText = await page.locator('#results').innerText();
              const resultsBreakdown = await page.locator('#results-breakdown');;
              expect(resultsText).toMatch(/\d+\/10/); // Should show score out of 10
              expect(resultsBreakdown).toBeVisible(); // Should show breakdown of results
              const resultItem = await page.locator('.result-item').first();
              expect(resultItem).toBeVisible();
              expect(resultItem.evaluate(el => el.backgroundColor)).toBe('rgba(74, 222, 128, 0.25)' || 'rgba(239, 68, 68, 0.25)'); // Should be win or loss
            });

            test('Page performance and loading', async ({ page }) => {
              const startTime = Date.now();
              await page.goto('http://localhost:3000');
              
              // Wait for page to be fully loaded
              await page.waitForLoadState('networkidle');
              const loadTime = Date.now() - startTime;
              
              // Page should load within 5 seconds
              expect(loadTime).toBeLessThan(5000);
              
              // Check that critical CSS is loaded
              const bodyBg = await page.locator('body').evaluate(el => getComputedStyle(el).backgroundColor);
              expect(bodyBg).toBe('rgb(17, 17, 17)'); // Should be dark background
            });
          });
          EOF

      - name: Run E2E tests
        run: npx playwright test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Stop local server
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi

    - name: Trigger Deploy Workflow
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'build-and-deploy.yml',
            ref: 'main'
          })
          console.log('âœ… Triggered Deploy workflow')